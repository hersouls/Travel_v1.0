## ìš”ì•½
Moonwave Travel í”„ë¡œì íŠ¸ì˜ ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°ë¥¼ ë¶„ì„í•˜ì—¬ ERD(Entity Relationship Diagram) ë¬¸ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤. Supabase PostgreSQL ê¸°ë°˜ì˜ ì—¬í–‰ í”Œë˜ë‹ ì‹œìŠ¤í…œ ë°ì´í„° ëª¨ë¸ì„ ì‹œê°í™”í•˜ê³  ê´€ê³„ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.

## ë¶„ì„
í”„ë¡œì íŠ¸ ë¬¸ì„œ ë¶„ì„ ê²°ê³¼:
- **í•µì‹¬ ì—”í‹°í‹°**: ì‚¬ìš©ì(profiles), ì—¬í–‰ì¼ì •(travel_plans), ì¼ìë³„ê³„íš(travel_days), ì„¸ë¶€ê³„íš(day_plans), ê²°ì œì´ë ¥(payment_history)
- **ë³´ì•ˆ ì •ì±…**: RLS(Row Level Security) ê¸°ë°˜ ì‚¬ìš©ìë³„ ë°ì´í„° ê²©ë¦¬
- **ê´€ê³„ ì„¤ê³„**: ê³„ì¸µì  1:N ê´€ê³„ êµ¬ì¡° (ì‚¬ìš©ìâ†’ì—¬í–‰â†’ì¼ìâ†’ê³„íš)
- **í™•ì¥ ê³ ë ¤ì‚¬í•­**: í˜‘ì—…, ì•Œë¦¼, ì¹´í…Œê³ ë¦¬ ë“± í–¥í›„ í™•ì¥ í…Œì´ë¸” í¬í•¨

## ì‹¤í–‰

# Moonwave Travel ERD (Entity Relationship Diagram) v1.0

> "ê°€ì§œ íë¦„ì´ ì•„ë‹Œ, ì‹¤ì œ íë¦„ìœ¼ë¡œ ì„¤ê³„í•œë‹¤" - Supabase ê¸°ë°˜ ì—¬í–‰ í”Œë˜ë‹ ë°ì´í„°ë² ì´ìŠ¤

## ğŸ“Š ERD ë‹¤ì´ì–´ê·¸ë¨

```mermaid
erDiagram
    %% ì‚¬ìš©ì ê´€ë ¨
    auth_users ||--|| profiles : "has"
    profiles ||--o{ travel_plans : "creates"
    profiles ||--o{ notifications : "receives"
    profiles ||--o{ categories : "owns"
    
    %% ì—¬í–‰ ê³„íš ê´€ë ¨
    travel_plans ||--o{ travel_days : "contains"
    travel_plans ||--o{ collaborators : "shares_with"
    travel_days ||--o{ day_plans : "includes"
    
    %% ê²°ì œ ë° ì´ë ¥
    travel_plans ||--o{ payment_history : "tracks"
    day_plans ||--o{ payment_history : "records"
    
    %% ì—”í‹°í‹° ì •ì˜
    auth_users {
        uuid id PK
        string email UK
        timestamp created_at
        timestamp updated_at
    }
    
    profiles {
        uuid id PK,FK
        string email UK
        string name
        string avatar_url
        integer subscription_count
        decimal total_monthly_cost
        jsonb preferences
        string timezone
        timestamp created_at
        timestamp updated_at
    }
    
    travel_plans {
        uuid id PK
        uuid user_id FK
        string title
        string destination
        date start_date
        date end_date
        string description
        string cover_image_url
        boolean is_public
        string status
        string[] collaborators
        jsonb metadata
        timestamp created_at
        timestamp updated_at
    }
    
    travel_days {
        uuid id PK
        uuid travel_plan_id FK
        integer day_number
        date date
        string title
        string theme
        timestamp created_at
    }
    
    day_plans {
        uuid id PK
        uuid travel_day_id FK
        string place_name
        string place_address
        string google_place_id
        decimal latitude
        decimal longitude
        time planned_time
        integer duration_minutes
        string plan_type
        text notes
        string[] image_urls
        string youtube_url
        decimal budget
        integer order_index
        jsonb metadata
        timestamp created_at
        timestamp updated_at
    }
    
    payment_history {
        uuid id PK
        uuid travel_plan_id FK
        uuid day_plan_id FK
        decimal amount
        string currency
        date payment_date
        string status
        string payment_method
        string receipt_url
        timestamp created_at
    }
    
    notifications {
        uuid id PK
        uuid user_id FK
        string type
        string title
        text message
        boolean is_read
        timestamp scheduled_at
        timestamp sent_at
        jsonb metadata
        timestamp created_at
    }
    
    categories {
        uuid id PK
        uuid user_id FK
        string name
        string color
        string icon
        boolean is_default
        timestamp created_at
    }
    
    collaborators {
        uuid id PK
        uuid travel_plan_id FK
        uuid user_id FK
        string role
        string permissions[]
        timestamp invited_at
        timestamp joined_at
    }
```

## ğŸ—‚ í…Œì´ë¸” ìƒì„¸ ì •ì˜

### 1. ì‚¬ìš©ì ê´€ë ¨ í…Œì´ë¸”

#### `auth.users` (Supabase Auth ë‚´ì¥)
| ì»¬ëŸ¼ëª… | íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|--------|------|----------|------|
| id | UUID | PK | ì‚¬ìš©ì ê³ ìœ  ID |
| email | TEXT | UNIQUE, NOT NULL | ì´ë©”ì¼ ì£¼ì†Œ |
| created_at | TIMESTAMP | NOT NULL | ìƒì„±ì¼ì‹œ |
| updated_at | TIMESTAMP | NOT NULL | ìˆ˜ì •ì¼ì‹œ |

#### `public.profiles`
| ì»¬ëŸ¼ëª… | íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|--------|------|----------|------|
| id | UUID | PK, FK â†’ auth.users.id | ì‚¬ìš©ì ID |
| email | TEXT | UNIQUE, NOT NULL | ì´ë©”ì¼ |
| name | TEXT | | ì‚¬ìš©ì ì´ë¦„ |
| avatar_url | TEXT | | í”„ë¡œí•„ ì´ë¯¸ì§€ URL |
| subscription_count | INTEGER | DEFAULT 0 | êµ¬ë… ìˆ˜ |
| total_monthly_cost | DECIMAL(10,2) | DEFAULT 0 | ì›” ì´ë¹„ìš© |
| preferences | JSONB | | ì‚¬ìš©ì ì„¤ì • |
| timezone | TEXT | | ì‹œê°„ëŒ€ |
| created_at | TIMESTAMP | DEFAULT NOW() | ìƒì„±ì¼ì‹œ |
| updated_at | TIMESTAMP | DEFAULT NOW() | ìˆ˜ì •ì¼ì‹œ |

### 2. ì—¬í–‰ ê³„íš í…Œì´ë¸”

#### `public.travel_plans`
| ì»¬ëŸ¼ëª… | íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|--------|------|----------|------|
| id | UUID | PK, DEFAULT gen_random_uuid() | ì—¬í–‰ ID |
| user_id | UUID | FK â†’ profiles.id, NOT NULL | ìƒì„±ì ID |
| title | TEXT | NOT NULL | ì—¬í–‰ ì œëª© |
| destination | TEXT | NOT NULL | ëª©ì ì§€ |
| start_date | DATE | NOT NULL | ì‹œì‘ì¼ |
| end_date | DATE | NOT NULL | ì¢…ë£Œì¼ |
| description | TEXT | | ì„¤ëª… |
| cover_image_url | TEXT | | ëŒ€í‘œ ì´ë¯¸ì§€ |
| is_public | BOOLEAN | DEFAULT FALSE | ê³µê°œ ì—¬ë¶€ |
| status | TEXT | DEFAULT 'planning' | ìƒíƒœ |
| collaborators | TEXT[] | | í˜‘ì—…ì ID ëª©ë¡ |
| metadata | JSONB | | ì¶”ê°€ ë©”íƒ€ë°ì´í„° |
| created_at | TIMESTAMP | DEFAULT NOW() | ìƒì„±ì¼ì‹œ |
| updated_at | TIMESTAMP | DEFAULT NOW() | ìˆ˜ì •ì¼ì‹œ |

#### `public.travel_days`
| ì»¬ëŸ¼ëª… | íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|--------|------|----------|------|
| id | UUID | PK, DEFAULT gen_random_uuid() | Day ID |
| travel_plan_id | UUID | FK â†’ travel_plans.id, NOT NULL | ì—¬í–‰ ID |
| day_number | INTEGER | NOT NULL | Day ë²ˆí˜¸ |
| date | DATE | NOT NULL | ë‚ ì§œ |
| title | TEXT | | Day ì œëª© |
| theme | TEXT | | Day í…Œë§ˆ |
| created_at | TIMESTAMP | DEFAULT NOW() | ìƒì„±ì¼ì‹œ |

**ì œì•½ì¡°ê±´**: `UNIQUE(travel_plan_id, day_number)`

#### `public.day_plans`
| ì»¬ëŸ¼ëª… | íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|--------|------|----------|------|
| id | UUID | PK, DEFAULT gen_random_uuid() | ê³„íš ID |
| travel_day_id | UUID | FK â†’ travel_days.id, NOT NULL | Day ID |
| place_name | TEXT | NOT NULL | ì¥ì†Œëª… |
| place_address | TEXT | | ì£¼ì†Œ |
| google_place_id | TEXT | | Google Place ID |
| latitude | DECIMAL(10,8) | | ìœ„ë„ |
| longitude | DECIMAL(11,8) | | ê²½ë„ |
| planned_time | TIME | | ì˜ˆì • ì‹œê°„ |
| duration_minutes | INTEGER | | ì†Œìš” ì‹œê°„(ë¶„) |
| plan_type | TEXT | DEFAULT 'sightseeing' | ê³„íš ìœ í˜• |
| notes | TEXT | | ë©”ëª¨ |
| image_urls | TEXT[] | | ì´ë¯¸ì§€ URL ëª©ë¡ |
| youtube_url | TEXT | | ìœ íŠœë¸Œ ë§í¬ |
| budget | DECIMAL(10,2) | | ì˜ˆì‚° |
| order_index | INTEGER | DEFAULT 0 | ìˆœì„œ |
| metadata | JSONB | | ì¶”ê°€ ë©”íƒ€ë°ì´í„° |
| created_at | TIMESTAMP | DEFAULT NOW() | ìƒì„±ì¼ì‹œ |
| updated_at | TIMESTAMP | DEFAULT NOW() | ìˆ˜ì •ì¼ì‹œ |

### 3. ê²°ì œ ë° ì´ë ¥ í…Œì´ë¸”

#### `public.payment_history`
| ì»¬ëŸ¼ëª… | íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|--------|------|----------|------|
| id | UUID | PK, DEFAULT gen_random_uuid() | ê²°ì œ ID |
| travel_plan_id | UUID | FK â†’ travel_plans.id | ì—¬í–‰ ID |
| day_plan_id | UUID | FK â†’ day_plans.id | ê³„íš ID |
| amount | DECIMAL(10,2) | NOT NULL | ê¸ˆì•¡ |
| currency | TEXT | NOT NULL | í†µí™” |
| payment_date | DATE | NOT NULL | ê²°ì œì¼ |
| status | TEXT | DEFAULT 'completed' | ìƒíƒœ |
| payment_method | TEXT | | ê²°ì œ ë°©ë²• |
| receipt_url | TEXT | | ì˜ìˆ˜ì¦ URL |
| created_at | TIMESTAMP | DEFAULT NOW() | ìƒì„±ì¼ì‹œ |

### 4. í™•ì¥ ê¸°ëŠ¥ í…Œì´ë¸”

#### `public.notifications`
| ì»¬ëŸ¼ëª… | íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|--------|------|----------|------|
| id | UUID | PK, DEFAULT gen_random_uuid() | ì•Œë¦¼ ID |
| user_id | UUID | FK â†’ profiles.id, NOT NULL | ì‚¬ìš©ì ID |
| type | TEXT | NOT NULL | ì•Œë¦¼ ìœ í˜• |
| title | TEXT | NOT NULL | ì œëª© |
| message | TEXT | | ë©”ì‹œì§€ |
| is_read | BOOLEAN | DEFAULT FALSE | ì½ìŒ ì—¬ë¶€ |
| scheduled_at | TIMESTAMP | | ì˜ˆì•½ ì‹œê°„ |
| sent_at | TIMESTAMP | | ë°œì†¡ ì‹œê°„ |
| metadata | JSONB | | ì¶”ê°€ ë°ì´í„° |
| created_at | TIMESTAMP | DEFAULT NOW() | ìƒì„±ì¼ì‹œ |

## ğŸ” RLS (Row Level Security) ì •ì±…

```sql
-- ì‚¬ìš©ìë³„ ë°ì´í„° ê²©ë¦¬
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE travel_plans ENABLE ROW LEVEL SECURITY;
ALTER TABLE travel_days ENABLE ROW LEVEL SECURITY;
ALTER TABLE day_plans ENABLE ROW LEVEL SECURITY;
ALTER TABLE payment_history ENABLE ROW LEVEL SECURITY;
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;

-- ì •ì±… ì˜ˆì‹œ
CREATE POLICY "Users can manage own travel plans" 
ON travel_plans FOR ALL 
USING (auth.uid() = user_id OR auth.uid() = ANY(collaborators));

CREATE POLICY "Public travels are readable" 
ON travel_plans FOR SELECT 
USING (is_public = true);

CREATE POLICY "Users can manage own notifications" 
ON notifications FOR ALL 
USING (auth.uid() = user_id);
```

## ğŸ”„ íŠ¸ë¦¬ê±° ë° í•¨ìˆ˜

```sql
-- ì‚¬ìš©ì í†µê³„ ìë™ ì—…ë°ì´íŠ¸
CREATE OR REPLACE FUNCTION update_user_travel_stats()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE profiles SET 
    subscription_count = (
      SELECT COUNT(*) FROM travel_plans 
      WHERE user_id = COALESCE(NEW.user_id, OLD.user_id)
    ),
    updated_at = NOW()
  WHERE id = COALESCE(NEW.user_id, OLD.user_id);
  
  RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_travel_stats_trigger
  AFTER INSERT OR UPDATE OR DELETE ON travel_plans
  FOR EACH ROW EXECUTE FUNCTION update_user_travel_stats();

-- updated_at ìë™ ì—…ë°ì´íŠ¸
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_travel_plans_updated_at 
  BEFORE UPDATE ON travel_plans
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

## ğŸ“‘ ì¸ë±ìŠ¤ ì„¤ê³„

```sql
-- ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤
CREATE INDEX idx_travel_plans_user_id ON travel_plans(user_id);
CREATE INDEX idx_travel_plans_status ON travel_plans(status);
CREATE INDEX idx_travel_days_travel_plan_id ON travel_days(travel_plan_id);
CREATE INDEX idx_day_plans_travel_day_id ON day_plans(travel_day_id);
CREATE INDEX idx_day_plans_google_place_id ON day_plans(google_place_id);
CREATE INDEX idx_notifications_user_id_is_read ON notifications(user_id, is_read);
```

---

**Moonwave Travel ERD v1.0**  
*ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„: Supabase PostgreSQL + RLS + Realtime*  
*í™•ì¥ì„±ê³¼ ë³´ì•ˆì„ ê³ ë ¤í•œ ê³„ì¸µì  ë°ì´í„° ëª¨ë¸*
