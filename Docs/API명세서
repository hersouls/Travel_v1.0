## ìš”ì•½
Moonwave Travelì˜ ëª¨ë“  í”„ë¡œì íŠ¸ ë¬¸ì„œë¥¼ í†µí•© ë¶„ì„í•˜ì—¬, Supabase Client SDK ê¸°ë°˜ì˜ ë°ì´í„° ì ‘ê·¼ íŒ¨í„´ê³¼ Google Maps API ì—°ë™ì„ í¬í•¨í•œ ì™„ì „í•œ API ëª…ì„¸ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

## ë¶„ì„

### ğŸ“¡ API ì•„í‚¤í…ì²˜ íŠ¹ì§•
- **Supabase Client SDK**: REST API ëŒ€ì‹  ì§ì ‘ DB ì ‘ê·¼
- **ì‹¤ì‹œê°„ êµ¬ë…**: WebSocket ê¸°ë°˜ ì‹¤ì‹œê°„ ë™ê¸°í™”
- **Row Level Security**: ì‚¬ìš©ìë³„ ë°ì´í„° ê²©ë¦¬
- **Google APIs**: Maps & Places í†µí•©

### ğŸ” í•µì‹¬ ë³´ì•ˆ ì •ì±…
- JWT ê¸°ë°˜ ì¸ì¦
- RLS ì •ì±…ìœ¼ë¡œ ë°ì´í„° ë³´í˜¸
- í™˜ê²½ ë³€ìˆ˜ë¡œ API í‚¤ ê´€ë¦¬

## ì‹¤í–‰

# Moonwave Travel API ëª…ì„¸ì„œ v1.0

> "ê°€ì§œ íë¦„ì´ ì•„ë‹Œ, ì‹¤ì œ íë¦„ìœ¼ë¡œ ì„¤ê³„í•œë‹¤" - Supabase ì‹¤ì‹œê°„ DB ê¸°ë°˜ API

## ğŸ“‹ ëª©ì°¨
1. [API ê°œìš”](#1-api-ê°œìš”)
2. [ì¸ì¦ ë° ê¶Œí•œ](#2-ì¸ì¦-ë°-ê¶Œí•œ)
3. [ë°ì´í„° ëª¨ë¸](#3-ë°ì´í„°-ëª¨ë¸)
4. [Supabase ì¿¼ë¦¬ API](#4-supabase-ì¿¼ë¦¬-api)
5. [ì‹¤ì‹œê°„ êµ¬ë… API](#5-ì‹¤ì‹œê°„-êµ¬ë…-api)
6. [ì™¸ë¶€ API ì—°ë™](#6-ì™¸ë¶€-api-ì—°ë™)
7. [ì—ëŸ¬ ì²˜ë¦¬](#7-ì—ëŸ¬-ì²˜ë¦¬)
8. [ì‚¬ìš© ì˜ˆì œ](#8-ì‚¬ìš©-ì˜ˆì œ)

---

## 1. API ê°œìš”

### 1.1 ê¸°ë³¸ ì •ë³´

```typescript
const API_CONFIG = {
  // Supabase ì—”ë“œí¬ì¸íŠ¸
  supabase: {
    url: process.env.NEXT_PUBLIC_SUPABASE_URL,
    anonKey: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,
    protocol: "HTTPS",
    sdk: "@supabase/supabase-js"
  },
  
  // Google APIs
  google: {
    mapsApiKey: process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY,
    placesApiKey: process.env.NEXT_PUBLIC_GOOGLE_PLACES_API_KEY,
    libraries: ["places", "geometry", "drawing"]
  },
  
  // ì œí•œì‚¬í•­
  limits: {
    maxFileSize: "5MB",
    requestsPerMinute: 100,
    realtimeChannels: 10
  }
};
```

### 1.2 API ì ‘ê·¼ ë°©ì‹

```typescript
// âŒ ì „í†µì ì¸ REST API (ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
// GET /api/travels
// POST /api/travels
// PUT /api/travels/:id

// âœ… Supabase Client SDK (Moonwave í‘œì¤€)
const { data, error } = await supabase
  .from('travel_plans')
  .select('*')
  .eq('user_id', userId);
```

---

## 2. ì¸ì¦ ë° ê¶Œí•œ

### 2.1 ì¸ì¦ ë°©ì‹

#### Magic Link ì¸ì¦
```typescript
// ì´ë©”ì¼ë¡œ ë§¤ì§ ë§í¬ ì „ì†¡
const { error } = await supabase.auth.signInWithOtp({
  email: 'user@example.com',
  options: {
    emailRedirectTo: 'https://travel.moonwave.kr/auth/callback'
  }
});

// Response
{
  error: null | {
    message: string,
    status: number
  }
}
```

#### OAuth ì¸ì¦
```typescript
// Google OAuth
const { data, error } = await supabase.auth.signInWithOAuth({
  provider: 'google',
  options: {
    redirectTo: 'https://travel.moonwave.kr/auth/callback',
    scopes: 'profile email'
  }
});

// GitHub OAuth
const { data, error } = await supabase.auth.signInWithOAuth({
  provider: 'github',
  options: {
    redirectTo: 'https://travel.moonwave.kr/auth/callback'
  }
});
```

#### ì„¸ì…˜ ê´€ë¦¬
```typescript
// í˜„ì¬ ì„¸ì…˜ ê°€ì ¸ì˜¤ê¸°
const { data: { session }, error } = await supabase.auth.getSession();

// ì„¸ì…˜ ê°±ì‹ 
const { data, error } = await supabase.auth.refreshSession();

// ë¡œê·¸ì•„ì›ƒ
const { error } = await supabase.auth.signOut();
```

### 2.2 ê¶Œí•œ ê´€ë¦¬ (RLS)

```sql
-- ì‚¬ìš©ìë³„ ì—¬í–‰ ê³„íš ì ‘ê·¼ ê¶Œí•œ
CREATE POLICY "travel_plans_policy" ON travel_plans
  FOR ALL USING (
    auth.uid() = user_id 
    OR 
    auth.uid() = ANY(collaborators)
  );

-- ê³µê°œ ì—¬í–‰ì€ ì½ê¸°ë§Œ ê°€ëŠ¥
CREATE POLICY "public_travel_read" ON travel_plans
  FOR SELECT USING (
    is_public = true
  );
```

---

## 3. ë°ì´í„° ëª¨ë¸

### 3.1 í•µì‹¬ ì—”í‹°í‹°

```typescript
// ì‚¬ìš©ì í”„ë¡œí•„
interface UserProfile {
  id: string;                    // UUID (auth.users.id)
  email: string;
  name?: string;
  avatar_url?: string;
  preferences?: {
    language: string;
    timezone: string;
    notifications: boolean;
  };
  travel_stats?: {
    total_trips: number;
    total_plans: number;
  };
  created_at: string;
  updated_at: string;
}

// ì—¬í–‰ ì¼ì •
interface TravelPlan {
  id: string;                    // UUID
  user_id: string;               // FK â†’ user_profiles.id
  title: string;
  destination: string;
  start_date: string;            // YYYY-MM-DD
  end_date: string;
  description?: string;
  cover_image_url?: string;
  is_public: boolean;
  status: 'planning' | 'ongoing' | 'completed' | 'cancelled';
  collaborators: string[];       // User IDs
  metadata?: {
    tags?: string[];
    budget?: number;
    currency?: string;
  };
  created_at: string;
  updated_at: string;
}

// Dayë³„ ì¼ì •
interface TravelDay {
  id: string;                    // UUID
  travel_plan_id: string;        // FK â†’ travel_plans.id
  day_number: number;            // 1, 2, 3...
  date: string;                  // YYYY-MM-DD
  title?: string;
  theme?: string;
  created_at: string;
}

// ì„¸ë¶€ ê³„íš
interface DayPlan {
  id: string;                    // UUID
  travel_day_id: string;         // FK â†’ travel_days.id
  place_name: string;
  place_address?: string;
  google_place_id?: string;
  location?: {
    lat: number;
    lng: number;
  };
  planned_time?: string;         // HH:MM
  duration_minutes?: number;
  plan_type: 'sightseeing' | 'dining' | 'shopping' | 'transportation' | 'accommodation' | 'other';
  notes?: string;
  image_urls: string[];
  youtube_url?: string;
  budget?: number;
  order_index: number;
  metadata?: {
    rating?: number;
    tags?: string[];
  };
  created_at: string;
  updated_at: string;
}
```

---

## 4. Supabase ì¿¼ë¦¬ API

### 4.1 ì—¬í–‰ ê³„íš (Travel Plans)

#### ì—¬í–‰ ëª©ë¡ ì¡°íšŒ
```typescript
// ì¿¼ë¦¬
const { data, error } = await supabase
  .from('travel_plans')
  .select(`
    *,
    user_profiles!user_id (
      name,
      avatar_url
    )
  `)
  .eq('user_id', userId)
  .order('created_at', { ascending: false })
  .limit(20);

// Response Type
type TravelPlansResponse = {
  data: Array<TravelPlan & {
    user_profiles: Pick<UserProfile, 'name' | 'avatar_url'>;
  }> | null;
  error: PostgrestError | null;
}
```

#### ì—¬í–‰ ìƒì„¸ ì¡°íšŒ
```typescript
// ì¿¼ë¦¬
const { data, error } = await supabase
  .from('travel_plans')
  .select(`
    *,
    travel_days (
      *,
      day_plans (
        *
      )
    )
  `)
  .eq('id', travelId)
  .single();

// Response Type
type TravelDetailResponse = {
  data: TravelPlan & {
    travel_days: Array<TravelDay & {
      day_plans: DayPlan[];
    }>;
  } | null;
  error: PostgrestError | null;
}
```

#### ì—¬í–‰ ìƒì„±
```typescript
// ì¿¼ë¦¬
const { data, error } = await supabase
  .from('travel_plans')
  .insert({
    user_id: userId,
    title: 'ì œì£¼ë„ ì—¬í–‰',
    destination: 'ì œì£¼ë„',
    start_date: '2025-08-15',
    end_date: '2025-08-20',
    description: 'ì—¬ë¦„ íœ´ê°€ ì œì£¼ë„ ì—¬í–‰',
    is_public: false,
    status: 'planning'
  })
  .select()
  .single();

// Request Body Type
type CreateTravelRequest = {
  title: string;
  destination: string;
  start_date: string;
  end_date: string;
  description?: string;
  cover_image_url?: string;
  is_public?: boolean;
}
```

#### ì—¬í–‰ ìˆ˜ì •
```typescript
// ì¿¼ë¦¬
const { data, error } = await supabase
  .from('travel_plans')
  .update({
    title: 'ìˆ˜ì •ëœ ì œëª©',
    description: 'ìˆ˜ì •ëœ ì„¤ëª…',
    updated_at: new Date().toISOString()
  })
  .eq('id', travelId)
  .eq('user_id', userId) // ì†Œìœ ì í™•ì¸
  .select()
  .single();

// Request Body Type
type UpdateTravelRequest = Partial<CreateTravelRequest>;
```

#### ì—¬í–‰ ì‚­ì œ
```typescript
// ì¿¼ë¦¬ (Cascade ì‚­ì œ)
const { error } = await supabase
  .from('travel_plans')
  .delete()
  .eq('id', travelId)
  .eq('user_id', userId);
```

### 4.2 Dayë³„ ê³„íš (Day Plans)

#### Dayë³„ ê³„íš ì¡°íšŒ
```typescript
// ì¿¼ë¦¬
const { data, error } = await supabase
  .from('travel_days')
  .select(`
    *,
    day_plans (
      *
    )
  `)
  .eq('travel_plan_id', travelPlanId)
  .order('day_number', { ascending: true });

// Response Type
type TravelDaysResponse = {
  data: Array<TravelDay & {
    day_plans: DayPlan[];
  }> | null;
  error: PostgrestError | null;
}
```

#### ê³„íš ì¶”ê°€
```typescript
// ì¿¼ë¦¬
const { data, error } = await supabase
  .from('day_plans')
  .insert({
    travel_day_id: dayId,
    place_name: 'ì„±ì‚°ì¼ì¶œë´‰',
    place_address: 'ì œì£¼íŠ¹ë³„ìì¹˜ë„ ì„œê·€í¬ì‹œ ì„±ì‚°ì',
    google_place_id: 'ChIJN1t_tDeuEmsRUsoyG83frY4',
    location: { lat: 33.458427, lng: 126.942478 },
    planned_time: '09:00',
    duration_minutes: 120,
    plan_type: 'sightseeing',
    notes: 'ì¼ì¶œ ë³´ê¸°',
    order_index: 1
  })
  .select()
  .single();

// Request Body Type
type CreateDayPlanRequest = {
  travel_day_id: string;
  place_name: string;
  place_address?: string;
  google_place_id?: string;
  location?: { lat: number; lng: number };
  planned_time?: string;
  duration_minutes?: number;
  plan_type: DayPlan['plan_type'];
  notes?: string;
  image_urls?: string[];
  youtube_url?: string;
  budget?: number;
  order_index: number;
}
```

#### ê³„íš ìˆœì„œ ë³€ê²½
```typescript
// ì¿¼ë¦¬ (Batch Update)
const updates = plans.map((plan, index) => ({
  id: plan.id,
  order_index: index
}));

const { error } = await supabase
  .from('day_plans')
  .upsert(updates);
```

### 4.3 ì´ë¯¸ì§€ ì—…ë¡œë“œ

#### ì´ë¯¸ì§€ ì—…ë¡œë“œ
```typescript
// Storage API
const file = event.target.files[0];
const fileName = `${userId}/${travelId}/${Date.now()}_${file.name}`;

const { data, error } = await supabase.storage
  .from('travel-images')
  .upload(fileName, file, {
    cacheControl: '3600',
    upsert: false
  });

// Response
{
  data: {
    path: string;
    id: string;
    fullPath: string;
  };
  error: StorageError | null;
}

// ê³µê°œ URL ê°€ì ¸ì˜¤ê¸°
const { data: { publicUrl } } = supabase.storage
  .from('travel-images')
  .getPublicUrl(fileName);
```

---

## 5. ì‹¤ì‹œê°„ êµ¬ë… API

### 5.1 ì‹¤ì‹œê°„ ì—¬í–‰ ì—…ë°ì´íŠ¸

```typescript
// ê°œì¸ ì—¬í–‰ ì—…ë°ì´íŠ¸ êµ¬ë…
const subscription = supabase
  .channel('personal-travels')
  .on('postgres_changes', {
    event: '*', // INSERT, UPDATE, DELETE
    schema: 'public',
    table: 'travel_plans',
    filter: `user_id=eq.${userId}`
  }, (payload) => {
    console.log('Travel updated:', payload);
    // payload.eventType: 'INSERT' | 'UPDATE' | 'DELETE'
    // payload.new: ìƒˆë¡œìš´ ë°ì´í„°
    // payload.old: ì´ì „ ë°ì´í„°
  })
  .subscribe();

// êµ¬ë… í•´ì œ
subscription.unsubscribe();
```

### 5.2 í˜‘ì—… ì‹¤ì‹œê°„ ë™ê¸°í™”

```typescript
// íŠ¹ì • ì—¬í–‰ì˜ ëª¨ë“  ë³€ê²½ì‚¬í•­ êµ¬ë…
const travelChannel = supabase
  .channel(`travel:${travelId}`)
  .on('postgres_changes', {
    event: '*',
    schema: 'public',
    table: 'day_plans',
    filter: `travel_day_id=in.(
      SELECT id FROM travel_days 
      WHERE travel_plan_id='${travelId}'
    )`
  }, handlePlanUpdate)
  .on('presence', { event: 'sync' }, () => {
    const state = travelChannel.presenceState();
    console.log('Active users:', state);
  })
  .subscribe();

// ì‚¬ìš©ì presence ì¶”ê°€
await travelChannel.track({
  user_id: userId,
  name: userName,
  avatar_url: userAvatar,
  online_at: new Date().toISOString()
});
```

### 5.3 ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ íƒ€ì…

```typescript
// ì‹¤ì‹œê°„ í˜ì´ë¡œë“œ íƒ€ì…
interface RealtimePayload<T> {
  eventType: 'INSERT' | 'UPDATE' | 'DELETE';
  new: T;                        // INSERT, UPDATE ì‹œ
  old: T;                        // UPDATE, DELETE ì‹œ
  schema: string;
  table: string;
  commit_timestamp: string;
}

// ì‚¬ìš© ì˜ˆì‹œ
.on('postgres_changes', { 
  event: '*', 
  schema: 'public', 
  table: 'travel_plans' 
}, (payload: RealtimePayload<TravelPlan>) => {
  switch (payload.eventType) {
    case 'INSERT':
      addTravelToUI(payload.new);
      break;
    case 'UPDATE':
      updateTravelInUI(payload.new);
      break;
    case 'DELETE':
      removeTravelFromUI(payload.old);
      break;
  }
})
```

---

## 6. ì™¸ë¶€ API ì—°ë™

### 6.1 Google Maps API

#### ì§€ë„ ì´ˆê¸°í™”
```typescript
// Google Maps ë¡œë“œ
const loader = new Loader({
  apiKey: process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY,
  version: "weekly",
  libraries: ["places", "geometry"]
});

const google = await loader.load();
const map = new google.maps.Map(mapElement, {
  center: { lat: 33.4501, lng: 126.5707 }, // ì œì£¼ë„
  zoom: 10,
  mapTypeId: 'roadmap',
  language: 'ko',
  region: 'KR'
});
```

#### ë§ˆì»¤ ì¶”ê°€
```typescript
// ê³„íšë³„ ë§ˆì»¤ ìƒì„±
dayPlans.forEach((plan) => {
  if (plan.location) {
    const marker = new google.maps.Marker({
      position: { 
        lat: plan.location.lat, 
        lng: plan.location.lng 
      },
      map: map,
      title: plan.place_name,
      icon: getMarkerIcon(plan.plan_type)
    });
    
    // ì •ë³´ì°½
    const infoWindow = new google.maps.InfoWindow({
      content: `
        <div class="font-pretendard">
          <h3 class="font-semibold">${plan.place_name}</h3>
          <p class="text-sm">${plan.planned_time || ''}</p>
          <p class="text-sm text-gray-600">${plan.notes || ''}</p>
        </div>
      `
    });
    
    marker.addListener('click', () => {
      infoWindow.open(map, marker);
    });
  }
});
```

### 6.2 Google Places API

#### ì¥ì†Œ ìë™ì™„ì„±
```typescript
// Places Autocomplete
const autocomplete = new google.maps.places.Autocomplete(inputElement, {
  types: ['establishment', 'geocode'],
  componentRestrictions: { country: 'kr' },
  fields: ['place_id', 'name', 'formatted_address', 'geometry', 'rating', 'opening_hours']
});

autocomplete.addListener('place_changed', () => {
  const place = autocomplete.getPlace();
  
  if (place.place_id) {
    // Supabaseì— ì €ì¥í•  ë°ì´í„°
    const placeData = {
      google_place_id: place.place_id,
      place_name: place.name,
      place_address: place.formatted_address,
      location: {
        lat: place.geometry.location.lat(),
        lng: place.geometry.location.lng()
      },
      metadata: {
        rating: place.rating,
        opening_hours: place.opening_hours?.weekday_text
      }
    };
  }
});
```

#### ì¥ì†Œ ìƒì„¸ ì •ë³´
```typescript
// Place Details
const service = new google.maps.places.PlacesService(map);

service.getDetails({
  placeId: googlePlaceId,
  fields: ['name', 'rating', 'formatted_phone_number', 'opening_hours', 'website', 'photos']
}, (place, status) => {
  if (status === google.maps.places.PlacesServiceStatus.OK) {
    // ì¥ì†Œ ì •ë³´ í™œìš©
    const details = {
      name: place.name,
      rating: place.rating,
      phone: place.formatted_phone_number,
      website: place.website,
      hours: place.opening_hours?.weekday_text,
      photos: place.photos?.map(photo => photo.getUrl({ maxWidth: 400 }))
    };
  }
});
```

---

## 7. ì—ëŸ¬ ì²˜ë¦¬

### 7.1 Supabase ì—ëŸ¬ ì½”ë“œ

```typescript
// ê³µí†µ ì—ëŸ¬ íƒ€ì…
interface SupabaseError {
  message: string;
  details?: string;
  hint?: string;
  code?: string;
}

// ì£¼ìš” ì—ëŸ¬ ì½”ë“œ
const ERROR_CODES = {
  // PostgreSQL ì—ëŸ¬
  '23505': 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë°ì´í„°ì…ë‹ˆë‹¤',
  '23503': 'ì°¸ì¡°í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤',
  '23502': 'í•„ìˆ˜ í•„ë“œê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤',
  '42501': 'ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤',
  'PGRST116': 'ìš”ì²­í•œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
  
  // Auth ì—ëŸ¬
  'invalid_credentials': 'ì˜ëª»ëœ ì¸ì¦ ì •ë³´ì…ë‹ˆë‹¤',
  'user_not_found': 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
  'email_not_confirmed': 'ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤',
  
  // Storage ì—ëŸ¬
  'object_not_found': 'íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
  'payload_too_large': 'íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤ (ìµœëŒ€ 5MB)',
  'invalid_mime_type': 'ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤'
};
```

### 7.2 ì—ëŸ¬ ì²˜ë¦¬ íŒ¨í„´

```typescript
// í†µí•© ì—ëŸ¬ í•¸ë“¤ëŸ¬
export const handleSupabaseError = (error: SupabaseError): string => {
  console.error('Supabase Error:', error);
  
  // í•œê¸€ ì—ëŸ¬ ë©”ì‹œì§€ ë§¤í•‘
  if (error.code && ERROR_CODES[error.code]) {
    return ERROR_CODES[error.code];
  }
  
  // ê¸°ë³¸ ì—ëŸ¬ ë©”ì‹œì§€
  return error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
};

// ì‚¬ìš© ì˜ˆì‹œ
try {
  const { data, error } = await supabase
    .from('travel_plans')
    .insert(travelData)
    .select()
    .single();
    
  if (error) throw error;
  
  return { success: true, data };
} catch (error) {
  const errorMessage = handleSupabaseError(error);
  toast.error(errorMessage);
  return { success: false, error: errorMessage };
}
```

### 7.3 ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ì²˜ë¦¬

```typescript
// ì¬ì‹œë„ ë¡œì§
export const retryableQuery = async <T>(
  queryFn: () => Promise<{ data: T; error: any }>,
  maxRetries = 3,
  delay = 1000
): Promise<{ data: T; error: any }> => {
  let lastError;
  
  for (let i = 0; i < maxRetries; i++) {
    try {
      const result = await queryFn();
      if (!result.error) return result;
      
      lastError = result.error;
      
      // ì¬ì‹œë„ ë¶ˆê°€ëŠ¥í•œ ì—ëŸ¬
      if (result.error.code === '42501') break;
      
      // ì§€ìˆ˜ ë°±ì˜¤í”„
      await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
    } catch (error) {
      lastError = error;
    }
  }
  
  return { data: null, error: lastError };
};
```

---

## 8. ì‚¬ìš© ì˜ˆì œ

### 8.1 ì™„ì „í•œ ì—¬í–‰ ìƒì„± í”Œë¡œìš°

```typescript
// hooks/useCreateTravel.ts
export const useCreateTravel = () => {
  const { supabase, user } = useSupabase();
  const [loading, setLoading] = useState(false);
  
  const createTravel = async (travelData: CreateTravelRequest) => {
    setLoading(true);
    
    try {
      // 1. ì—¬í–‰ ê³„íš ìƒì„±
      const { data: travel, error: travelError } = await supabase
        .from('travel_plans')
        .insert({
          ...travelData,
          user_id: user.id,
          status: 'planning'
        })
        .select()
        .single();
        
      if (travelError) throw travelError;
      
      // 2. Dayë³„ ì¼ì • ìë™ ìƒì„±
      const days = [];
      const startDate = new Date(travel.start_date);
      const endDate = new Date(travel.end_date);
      const dayCount = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
      
      for (let i = 0; i < dayCount; i++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);
        
        days.push({
          travel_plan_id: travel.id,
          day_number: i + 1,
          date: currentDate.toISOString().split('T')[0],
          title: `Day ${i + 1}`
        });
      }
      
      const { error: daysError } = await supabase
        .from('travel_days')
        .insert(days);
        
      if (daysError) throw daysError;
      
      // 3. ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ íŠ¸ë¦¬ê±°
      // (êµ¬ë… ì¤‘ì¸ ì»´í¬ë„ŒíŠ¸ì—ì„œ ìë™ìœ¼ë¡œ ë°˜ì˜ë¨)
      
      return { success: true, data: travel };
      
    } catch (error) {
      const errorMessage = handleSupabaseError(error);
      return { success: false, error: errorMessage };
    } finally {
      setLoading(false);
    }
  };
  
  return { createTravel, loading };
};
```

### 8.2 ì‹¤ì‹œê°„ í˜‘ì—… ì˜ˆì œ

```typescript
// components/CollaborativeEditor.tsx
export const CollaborativeEditor = ({ travelId }: Props) => {
  const [plans, setPlans] = useState<DayPlan[]>([]);
  const [activeUsers, setActiveUsers] = useState<any[]>([]);
  const { supabase, user } = useSupabase();
  
  useEffect(() => {
    // 1. ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    loadPlans();
    
    // 2. ì‹¤ì‹œê°„ êµ¬ë… ì„¤ì •
    const channel = supabase
      .channel(`travel:${travelId}`)
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'day_plans'
      }, (payload) => {
        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
        if (payload.eventType === 'INSERT') {
          setPlans(prev => [...prev, payload.new as DayPlan]);
        } else if (payload.eventType === 'UPDATE') {
          setPlans(prev => prev.map(p => 
            p.id === payload.new.id ? payload.new as DayPlan : p
          ));
        } else if (payload.eventType === 'DELETE') {
          setPlans(prev => prev.filter(p => p.id !== payload.old.id));
        }
      })
      .on('presence', { event: 'sync' }, () => {
        const state = channel.presenceState();
        setActiveUsers(Object.values(state).flat());
      })
      .subscribe();
    
    // 3. ì‚¬ìš©ì presence ë“±ë¡
    channel.track({
      user_id: user.id,
      name: user.name,
      cursor: null
    });
    
    return () => {
      channel.unsubscribe();
    };
  }, [travelId]);
  
  return (
    <div>
      {/* í™œì„± ì‚¬ìš©ì í‘œì‹œ */}
      <div className="flex gap-2 mb-4">
        {activeUsers.map(user => (
          <div key={user.user_id} className="flex items-center gap-2">
            <img src={user.avatar_url} className="w-8 h-8 rounded-full" />
            <span className="text-sm">{user.name}</span>
          </div>
        ))}
      </div>
      
      {/* ê³„íš ëª©ë¡ */}
      <div className="space-y-4">
        {plans.map(plan => (
          <DayPlanCard key={plan.id} plan={plan} />
        ))}
      </div>
    </div>
  );
};
```

### 8.3 ì´ë¯¸ì§€ ì—…ë¡œë“œ í”Œë¡œìš°

```typescript
// hooks/useImageUpload.ts
export const useImageUpload = () => {
  const { supabase, user } = useSupabase();
  const [uploading, setUploading] = useState(false);
  
  const uploadImage = async (
    file: File,
    travelId: string
  ): Promise<{ url: string } | { error: string }> => {
    setUploading(true);
    
    try {
      // 1. íŒŒì¼ ê²€ì¦
      if (file.size > 5 * 1024 * 1024) {
        throw new Error('íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤');
      }
      
      if (!file.type.startsWith('image/')) {
        throw new Error('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤');
      }
      
      // 2. íŒŒì¼ëª… ìƒì„±
      const fileExt = file.name.split('.').pop();
      const fileName = `${user.id}/${travelId}/${Date.now()}.${fileExt}`;
      
      // 3. ì—…ë¡œë“œ
      const { error: uploadError } = await supabase.storage
        .from('travel-images')
        .upload(fileName, file, {
          cacheControl: '3600',
          upsert: false
        });
        
      if (uploadError) throw uploadError;
      
      // 4. ê³µê°œ URL ìƒì„±
      const { data: { publicUrl } } = supabase.storage
        .from('travel-images')
        .getPublicUrl(fileName);
      
      return { url: publicUrl };
      
    } catch (error) {
      return { error: error.message };
    } finally {
      setUploading(false);
    }
  };
  
  return { uploadImage, uploading };
};
```

---

## ğŸ“‹ API ë¹ ë¥¸ ì°¸ì¡°

### ì¸ì¦
- `supabase.auth.signInWithOtp()` - ë§¤ì§ ë§í¬ ë¡œê·¸ì¸
- `supabase.auth.signInWithOAuth()` - OAuth ë¡œê·¸ì¸
- `supabase.auth.getSession()` - ì„¸ì…˜ í™•ì¸
- `supabase.auth.signOut()` - ë¡œê·¸ì•„ì›ƒ

### ë°ì´í„° ì¡°íšŒ
- `.select()` - ë°ì´í„° ì¡°íšŒ
- `.eq()` - ë™ë“± í•„í„°
- `.order()` - ì •ë ¬
- `.limit()` - ê°œìˆ˜ ì œí•œ
- `.single()` - ë‹¨ì¼ ê²°ê³¼

### ë°ì´í„° ì¡°ì‘
- `.insert()` - ìƒì„±
- `.update()` - ìˆ˜ì •
- `.delete()` - ì‚­ì œ
- `.upsert()` - ìƒì„± ë˜ëŠ” ìˆ˜ì •

### ì‹¤ì‹œê°„
- `.channel()` - ì±„ë„ ìƒì„±
- `.on('postgres_changes')` - DB ë³€ê²½ êµ¬ë…
- `.on('presence')` - ì‚¬ìš©ì ìƒíƒœ
- `.subscribe()` - êµ¬ë… ì‹œì‘
- `.unsubscribe()` - êµ¬ë… í•´ì œ

---

**Moonwave Travel API ëª…ì„¸ì„œ v1.0**  
*"ê°€ì§œ íë¦„ì´ ì•„ë‹Œ, ì‹¤ì œ íë¦„ìœ¼ë¡œ ì„¤ê³„í•œë‹¤"*  
*Supabase Client SDK + Google APIs + ì‹¤ì‹œê°„ ë™ê¸°í™”*

ì´ API ëª…ì„¸ì„œëŠ” Moonwave Travelì˜ ëª¨ë“  ë°ì´í„° ì ‘ê·¼ íŒ¨í„´ê³¼ ì™¸ë¶€ API ì—°ë™ ë°©ë²•ì„ í¬í•¨í•˜ê³  ìˆìœ¼ë©°, ì‹¤ì œ êµ¬í˜„ì— ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì½”ë“œ ì˜ˆì œë¥¼ ì œê³µí•©ë‹ˆë‹¤.
